#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CMD="${1:-help}"
shift || true

export GOCACHE="${GOCACHE:-/tmp/go-build}"

ensure_wails() {
  if command -v wails >/dev/null 2>&1; then
    return
  fi

  echo "[kitty] wails not found; installing github.com/wailsapp/wails/v2/cmd/wails@v2.10.2 ..."

  if ! command -v go >/dev/null 2>&1; then
    echo "[kitty] Go is required to build the app. Install Go 1.21+ and retry." >&2
    exit 1
  fi

  if ! go install github.com/wailsapp/wails/v2/cmd/wails@v2.10.2; then
    echo "[kitty] failed to install wails CLI" >&2
    exit 1
  fi

  BIN_DIR="${GOBIN:-$(go env GOPATH)/bin}"
  export PATH="$BIN_DIR:$PATH"
}

run_install() {
  npm install --prefix "$ROOT/frontend"
  go mod download
}

bundle_cobalt_runtime() {
  local targets=()

  if [[ -d "$ROOT/build/bin" ]]; then
    mkdir -p "$ROOT/build/bin/resources/app"
    rm -rf "$ROOT/build/bin/resources/app/api"
    cp -R "$ROOT/api" "$ROOT/build/bin/resources/app/api"
    targets+=("$ROOT/build/bin/resources/app")
  fi

  if [[ -d "$ROOT/build/bin/Kitty.app/Contents/Resources" ]]; then
    mkdir -p "$ROOT/build/bin/Kitty.app/Contents/Resources/app"
    rm -rf "$ROOT/build/bin/Kitty.app/Contents/Resources/app/api"
    cp -R "$ROOT/api" "$ROOT/build/bin/Kitty.app/Contents/Resources/app/api"
    targets+=("$ROOT/build/bin/Kitty.app/Contents/Resources/app")
  fi

  if [[ "${#targets[@]}" -eq 0 ]]; then
    return
  fi

  if [[ ! -d "$ROOT/node_modules/.pnpm" ]]; then
    echo "[kitty] cobalt runtime bundling skipped: $ROOT/node_modules/.pnpm not found (run pnpm install at repo root)" >&2
    return
  fi

  if [[ ! -d "$ROOT/packages" ]]; then
    echo "[kitty] cobalt runtime bundling skipped: $ROOT/packages not found" >&2
    return
  fi

  for t in "${targets[@]}"; do
    echo "[kitty] bundling cobalt runtime deps into $t ..."
    rm -rf "$t/node_modules" "$t/packages"
    cp -R "$ROOT/node_modules" "$t/node_modules"
    cp -R "$ROOT/packages" "$t/packages"
  done
}

case "$CMD" in
  install)
    run_install
    ;;
  bundle)
    bundle_cobalt_runtime
    ;;
  dev)
    ensure_wails
    run_install
    wails dev
    ;;
  build)
    ensure_wails
    run_install
    wails build
    bundle_cobalt_runtime
    if command -v xattr >/dev/null 2>&1; then
      xattr -dr com.apple.quarantine "$ROOT/build/bin/Kitty.app" 2>/dev/null || true
    fi
    ;;
  clean)
    rm -rf "$ROOT/frontend/dist" "$ROOT/build/bin" "$ROOT/dist"
    ;;
  help|*)
    cat <<'USAGE'
Kitty project helper

Usage:
  ./kitty install   Install frontend + Go deps
  ./kitty dev       Run Wails dev server with hot reload
  ./kitty build     Create a production build
  ./kitty bundle    Bundle the cobalt downloader runtime into an existing build output
  ./kitty clean     Remove build artifacts
USAGE
    ;;
 esac
